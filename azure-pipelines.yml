name: "InferSharp-AzurePipelinesExample-Multistage"

resources:
  containers:
  - container: infersharpcontainer
    image: mcr.microsoft.com/infersharp:latest

jobs:
# Example of existing build pipeline
- job: RunExistingBuildPipeline
  pool:
    vmImage: 'windows-2019'

  steps:
  # Build
  - task: DotNetCoreCLI@2
    displayName: 'dotnet build'
    inputs:
      projects: ConsoleApp1/ConsoleApp1.sln
  
  # Copy binaries to a staging folder
  - task: CopyFiles@2
    displayName: 'Copy output binaries'
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)/ConsoleApp1/ConsoleApp1/bin/Debug'
      Contents: '**\?(*.dll|*.pdb|*.exe)'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'
  
  # Publish binaries
  - task: PublishBuildArtifacts@1
    displayName: 'Publish binaries'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'inferinput'
      publishLocation: 'Container'

# Run Infer#
- job: RunInferSharp
  dependsOn: 'RunExistingBuildPipeline'
  pool:
    vmImage: 'ubuntu-20.04'
  container: infersharpcontainer

  steps:
  # Download binaries
  - task: DownloadBuildArtifacts@0
    displayName: 'Download binaries'
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: 'inferinput'
      downloadPath: '$(System.ArtifactsDirectory)'

  - script:
    target: infersharpcontainer
      sh run_infersharp.sh $(System.ArtifactsDirectory) output
    displayName: 'Run Infer# analysis'
  - script: cat $(Build.SourcesDirectory)/infer-out/filtered_bugs.txt
    displayName: 'Infer# analysis result'